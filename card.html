<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>–ö–∞—Ä—Ç–æ—á–∫–∏ –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è —Å–ª–æ–≤</title>
    <style>
        /* iPhone –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ */
        :root {
            --safe-area-inset-top: env(safe-area-inset-top);
            --safe-area-inset-bottom: env(safe-area-inset-bottom);
            --safe-area-inset-left: env(safe-area-inset-left);
            --safe-area-inset-right: env(safe-area-inset-right);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        html, body {
            height: 100%;
            overflow-x: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            min-height: -webkit-fill-available;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }
        
        .app {
            max-width: 100%;
            min-height: 100vh;
            min-height: -webkit-fill-available;
            margin: 0 auto;
            background: white;
            border-radius: 0;
            box-shadow: none;
            display: flex;
            flex-direction: column;
        }
        
        @supports(padding: max(0px)) {
            body {
                padding-left: min(0vmin, env(safe-area-inset-left));
                padding-right: min(0vmin, env(safe-area-inset-right));
                padding-top: min(0vmin, env(safe-area-inset-top));
                padding-bottom: min(0vmin, env(safe-area-inset-bottom));
            }
        }
        
        /* –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ —Å –∞–¥–∞–ø—Ç–∞—Ü–∏–µ–π –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
        header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 20px 15px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            padding-top: calc(15px + env(safe-area-inset-top));
        }
        
        .container {
            display: flex;
            flex: 1;
            flex-direction: column;
            min-height: 0;
        }
        
        @media (min-width: 768px) {
            .container {
                flex-direction: row;
            }
            
            .app {
                max-width: 1200px;
                border-radius: 15px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                min-height: auto;
                margin: 20px auto;
                overflow: hidden;
            }
            
            body {
                padding: 20px;
            }
            
            header {
                padding: 25px;
                padding-top: calc(25px + env(safe-area-inset-top));
                position: relative;
            }
        }
        
        .sidebar {
            width: 100%;
            background: #f8fafc;
            padding: 15px;
            overflow-y: auto;
            flex-shrink: 0;
            border-bottom: 1px solid #e2e8f0;
        }
        
        @media (min-width: 768px) {
            .sidebar {
                width: 300px;
                border-right: 1px solid #e2e8f0;
                border-bottom: none;
            }
        }
        
        .main-content {
            flex: 1;
            padding: 20px;
            background: white;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        /* –¢–∞–±—ã –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
        .tab-buttons {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            white-space: nowrap;
            padding-bottom: 10px;
            scrollbar-width: none;
        }
        
        .tab-buttons::-webkit-scrollbar {
            display: none;
        }
        
        .tab-btn {
            padding: 12px 15px;
            border: none;
            background: #f1f5f9;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            font-size: 14px;
            flex-shrink: 0;
        }
        
        .tab-btn.active {
            background: #4f46e5;
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* –ö–∞—Ä—Ç–æ—á–∫–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
        .card {
            perspective: 1000px;
            width: 100%;
            height: 250px;
            margin: 20px auto;
            touch-action: pan-y;
        }
        
        @media (min-width: 768px) {
            .card {
                height: 300px;
                max-width: 500px;
            }
        }
        
        .card-inner {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .card.flipped .card-inner {
            transform: rotateY(180deg);
        }
        
        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 600;
            padding: 30px;
            text-align: center;
            border-radius: 15px;
            word-break: break-word;
            overflow-wrap: break-word;
        }
        
        @media (min-width: 768px) {
            .card-front, .card-back {
                font-size: 28px;
                padding: 40px;
            }
        }
        
        .card-front {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .card-back {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            transform: rotateY(180deg);
        }
        
        /* –ö–Ω–æ–ø–∫–∏ —Å–º–∞—Ö–∏–≤–∞–Ω–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
        .swipe-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 25px;
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .swipe-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            user-select: none;
            touch-action: manipulation;
        }
        
        @media (min-width: 768px) {
            .swipe-btn {
                width: 80px;
                height: 80px;
                font-size: 24px;
            }
        }
        
        .swipe-left {
            background: #ef4444;
        }
        
        .swipe-right {
            background: #10b981;
        }
        
        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            margin: auto;
            position: relative;
        }
        
        /* –î–µ—Ä–µ–≤–æ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
        .tree-view {
            list-style: none;
            padding-left: 10px;
        }
        
        .tree-item {
            padding: 12px;
            margin: 5px 0;
            background: white;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* –§–æ—Ä–º—ã –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
        input, select, textarea {
            width: 100%;
            padding: 14px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            margin-top: 8px;
            -webkit-appearance: none;
            appearance: none;
        }
        
        textarea {
            min-height: 150px;
            resize: vertical;
        }
        
        button {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s;
            touch-action: manipulation;
            width: 100%;
            margin-bottom: 10px;
        }
        
        @media (min-width: 768px) {
            button {
                width: auto;
                margin-bottom: 0;
            }
        }
        
        button:hover {
            background: #4338ca;
        }
        
        button:active {
            transform: scale(0.98);
        }
        
        .btn-danger {
            background: #ef4444;
        }
        
        .btn-success {
            background: #10b981;
        }
        
        /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        
        @media (min-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 15px;
            }
        }
        
        .stat-card {
            background: #f8fafc;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e2e8f0;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #4f46e5;
            margin: 5px 0;
        }
        
        @media (min-width: 768px) {
            .stat-number {
                font-size: 32px;
            }
        }
        
        /* –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä */
        .progress-info {
            background: #f8fafc;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }
        
        .progress-bar {
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            transition: width 0.5s;
        }
        
        /* –ö–æ–Ω—Ç—Ä–æ–ª—ã –∫–∞—Ä—Ç–æ—á–µ–∫ */
        .flashcard-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }
        
        @media (min-width: 768px) {
            .flashcard-controls {
                flex-direction: row;
                justify-content: center;
                gap: 15px;
            }
        }
        
        /* –°–ø–∏—Å–æ–∫ –∫–æ–ª–æ–¥ */
        .deck-list-item {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 15px;
            margin: 10px 0;
            background: #f8fafc;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
        }
        
        @media (min-width: 768px) {
            .deck-list-item {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }
        
        .deck-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 8px 16px;
            font-size: 14px;
        }
        
        /* –î–ª—è iPhone —Å –≤—ã—Ä–µ–∑–æ–º */
        @media only screen and (device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3),
               only screen and (device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) {
            .swipe-buttons {
                margin-bottom: 30px;
            }
            
            .modal-content {
                margin: 20px;
            }
        }
        
        /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ iPhone –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ */
        input:focus, textarea:focus, select:focus {
            font-size: 16px;
        }
        
        /* –°–∫—Ä—ã—Ç—å —Å—Ç—Ä–µ–ª–∫–∏ —É number input */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
    </style>
</head>
<body>
    <div class="app">
        <header>
            <h1 style="font-size: 1.5rem; margin-bottom: 5px;">üìö –£–º–Ω—ã–µ –ö–∞—Ä—Ç–æ—á–∫–∏</h1>
            <p style="font-size: 0.9rem;">–ò–∑—É—á–∞–π—Ç–µ —Å–ª–æ–≤–∞ —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π</p>
            <div style="margin-top: 10px;">
                <button onclick="exportData()" style="width: auto; display: inline-block; margin-right: 10px; padding: 8px 16px; font-size: 14px;">üì§</button>
                <button onclick="importData()" style="width: auto; display: inline-block; padding: 8px 16px; font-size: 14px;">üì•</button>
            </div>
        </header>

        <div class="container">
            <div class="sidebar">
                <div class="tab-buttons">
                    <button class="tab-btn active" data-tab="folders">üìÅ</button>
                    <button class="tab-btn" data-tab="decks">üÉè</button>
                    <button class="tab-btn" data-tab="multi">üéØ</button>
                    <button class="tab-btn" data-tab="stats">üìä</button>
                </div>

                <div id="folders-tab" class="tab-content active">
                    <button onclick="showCreateFolderModal()" class="btn-success">+ –ü–∞–ø–∫–∞</button>
                    <ul id="folders-tree" class="tree-view"></ul>
                </div>

                <div id="decks-tab" class="tab-content">
                    <button onclick="showCreateDeckModal()" class="btn-success">+ –ö–æ–ª–æ–¥–∞</button>
                    <div id="decks-list"></div>
                </div>

                <div id="multi-tab" class="tab-content">
                    <h3 style="font-size: 1.1rem; margin-bottom: 15px;">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–æ–¥—ã:</h3>
                    <div id="multi-decks-select" style="margin-bottom: 15px;"></div>
                    <div class="form-group">
                        <select id="multi-mode" style="margin-bottom: 15px;">
                            <option value="all">–í—Å–µ —Å–ª–æ–≤–∞</option>
                            <option value="unknown">–ù–µ–∏–∑—É—á–µ–Ω–Ω—ã–µ</option>
                            <option value="iteration">–ò–∑ –∏—Ç–µ—Ä–∞—Ü–∏–π</option>
                        </select>
                    </div>
                    <div id="iteration-selectors" style="display: none; margin-bottom: 15px;"></div>
                    <button onclick="startMultiDeck()" class="btn-success">–ù–∞—á–∞—Ç—å</button>
                </div>

                <div id="stats-tab" class="tab-content">
                    <h3 style="font-size: 1.1rem; margin-bottom: 15px;">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div style="font-size: 0.8rem;">–°–ª–æ–≤</div>
                            <div class="stat-number" id="total-words">0</div>
                        </div>
                        <div class="stat-card">
                            <div style="font-size: 0.8rem;">–ò–∑—É—á–µ–Ω–æ</div>
                            <div class="stat-number" id="learned-words">0</div>
                        </div>
                        <div class="stat-card">
                            <div style="font-size: 0.8rem;">–ö–æ–ª–æ–¥</div>
                            <div class="stat-number" id="total-decks">0</div>
                        </div>
                        <div class="stat-card">
                            <div style="font-size: 0.8rem;">–ü–∞–ø–æ–∫</div>
                            <div class="stat-number" id="total-folders">0</div>
                        </div>
                    </div>
                    <div id="deck-stats" style="margin-top: 20px;"></div>
                </div>
            </div>

            <div class="main-content">
                <div id="main-content">
                    <h2 style="font-size: 1.3rem; margin-bottom: 15px;">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h2>
                    <p style="margin-bottom: 20px;">–°–æ–∑–¥–∞–π—Ç–µ –∫–æ–ª–æ–¥—É –∫–∞—Ä—Ç–æ—á–µ–∫ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é.</p>
                    <div class="progress-info">
                        <h3 style="font-size: 1.1rem; margin-bottom: 10px;">üìà –í–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å</h3>
                        <p style="font-size: 0.9rem;">–ó–¥–µ—Å—å –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–æ–ª–æ–¥–∞–º.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
    <div id="create-folder-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('create-folder-modal')" style="position: absolute; right: 20px; top: 20px; font-size: 24px; cursor: pointer;">√ó</span>
            <h3 style="margin-bottom: 15px;">–°–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É</h3>
            <input type="text" id="folder-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø–∞–ø–∫–∏" style="margin-bottom: 15px;">
            <button onclick="createFolder()" class="btn-success">–°–æ–∑–¥–∞—Ç—å</button>
        </div>
    </div>

    <div id="create-deck-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('create-deck-modal')" style="position: absolute; right: 20px; top: 20px; font-size: 24px; cursor: pointer;">√ó</span>
            <h3 style="margin-bottom: 15px;">–°–æ–∑–¥–∞—Ç—å –∫–æ–ª–æ–¥—É</h3>
            <div class="form-group" style="margin-bottom: 15px;">
                <input type="text" id="deck-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–ª–æ–¥—ã">
            </div>
            <div class="form-group" style="margin-bottom: 15px;">
                <textarea id="deck-words" placeholder="apple - —è–±–ª–æ–∫–æ
cat - –∫–æ—Ç
dog - —Å–æ–±–∞–∫–∞" rows="6"></textarea>
            </div>
            <div class="form-group" style="margin-bottom: 15px;">
                <select id="deck-folder">
                    <option value="">–ë–µ–∑ –ø–∞–ø–∫–∏</option>
                </select>
            </div>
            <button onclick="createDeck()" class="btn-success">–°–æ–∑–¥–∞—Ç—å</button>
        </div>
    </div>

    <div id="add-words-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('add-words-modal')" style="position: absolute; right: 20px; top: 20px; font-size: 24px; cursor: pointer;">√ó</span>
            <h3 style="margin-bottom: 15px;">–î–æ–±–∞–≤–∏—Ç—å —Å–ª–æ–≤–∞</h3>
            <textarea id="new-words" placeholder="apple - —è–±–ª–æ–∫–æ
cat - –∫–æ—Ç" rows="5" style="margin-bottom: 15px;"></textarea>
            <button onclick="addWordsToDeck()" class="btn-success">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
    </div>

    <div id="study-modal" class="modal">
        <div class="modal-content" style="max-height: 90vh;">
            <span class="close-modal" onclick="closeModal('study-modal')" style="position: absolute; right: 20px; top: 20px; font-size: 24px; cursor: pointer; z-index: 10;">√ó</span>
            <h3 id="study-title" style="margin-bottom: 15px; font-size: 1.2rem;">–ò–∑—É—á–µ–Ω–∏–µ</h3>
            
            <div class="flashcard-controls" style="margin-bottom: 15px;">
                <label style="display: flex; align-items: center; gap: 5px;">
                    <input type="checkbox" id="shuffle-cards"> –ü–µ—Ä–µ–º–µ—à–∏–≤–∞—Ç—å
                </label>
                <label style="display: flex; align-items: center; gap: 5px;">
                    <input type="checkbox" id="reverse-cards"> –û–±—Ä–∞—Ç–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞
                </label>
                <button onclick="restartDeck()" class="btn-danger" style="padding: 8px 12px; font-size: 14px;">–ó–∞–Ω–æ–≤–æ</button>
            </div>

            <div class="progress-info" style="margin-bottom: 15px;">
                <div style="font-size: 0.9rem; margin-bottom: 5px;"><span id="current-card">0</span>/<span id="total-cards">0</span></div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div style="font-size: 0.9rem; margin-top: 5px;">–ó–Ω–∞—é: <span id="known-count">0</span> | –ù–µ –∑–Ω–∞—é: <span id="unknown-count">0</span></div>
            </div>

            <div class="card" id="flashcard" onclick="flipCard()" style="touch-action: pan-y;">
                <div class="card-inner">
                    <div class="card-front" id="card-front"></div>
                    <div class="card-back" id="card-back"></div>
                </div>
            </div>

            <div class="swipe-buttons">
                <div class="swipe-btn swipe-left" onclick="markUnknown()" ontouchstart="event.preventDefault();">
                    ‚ùå
                </div>
                <div class="swipe-btn swipe-right" onclick="markKnown()" ontouchstart="event.preventDefault();">
                    ‚úÖ
                </div>
            </div>
        </div>
    </div>

    <script>
        // –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö
        let appData = {
            decks: [],
            folders: [],
            currentDeck: null,
            currentMultiDeck: null,
            studySession: null
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', () => {
            // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ bounce –Ω–∞ iOS
            document.body.addEventListener('touchmove', function(e) {
                if(e.target.classList.contains('modal-content') || 
                   e.target.closest('.modal-content') ||
                   e.target.classList.contains('card') ||
                   e.target.closest('.card')) {
                    e.stopPropagation();
                }
            }, { passive: false });
            
            loadData();
            initTabs();
            renderFoldersTree();
            renderDecksList();
            updateStats();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–≤–∞–π–ø–æ–≤ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫
            initSwipe();
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            window.addEventListener('beforeunload', saveData);
            window.addEventListener('pagehide', saveData);
        });
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–≤–∞–π–ø–æ–≤
        function initSwipe() {
            const card = document.getElementById('flashcard');
            if (!card) return;
            
            let startX, startY, isSwiping = false;
            
            card.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                isSwiping = true;
            }, { passive: true });
            
            card.addEventListener('touchmove', (e) => {
                if (!isSwiping) return;
                
                const currentX = e.touches[0].clientX;
                const diffX = currentX - startX;
                
                // –ï—Å–ª–∏ —Å–≤–∞–π–ø –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–æ–ª—å—à–æ–π –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏
                if (Math.abs(diffX) > 50) {
                    if (diffX > 0) {
                        markKnown();
                    } else {
                        markUnknown();
                    }
                    isSwiping = false;
                }
            }, { passive: true });
            
            card.addEventListener('touchend', () => {
                isSwiping = false;
            }, { passive: true });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ localStorage
        function loadData() {
            try {
                const saved = localStorage.getItem('flashcardAppData');
                if (saved) {
                    appData = JSON.parse(saved);
                    // –ú–∏–≥—Ä–∞—Ü–∏—è —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                    appData.decks.forEach(deck => {
                        if (!deck.iterations) deck.iterations = [];
                    });
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', e);
                appData = { decks: [], folders: [], currentDeck: null, studySession: null };
            }
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ localStorage
        function saveData() {
            try {
                localStorage.setItem('flashcardAppData', JSON.stringify(appData));
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:', e);
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∫–ª–∞–¥–æ–∫
        function initTabs() {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const tabId = btn.dataset.tab;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –≤–∫–ª–∞–¥–∫–∏
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                    if (tabId === 'multi') {
                        renderMultiDeckSelect();
                    }
                });
            });
        }

        // –ü–æ–∫–∞–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–∫–∏
        function showCreateFolderModal() {
            showModal('create-folder-modal');
            setTimeout(() => document.getElementById('folder-name').focus(), 100);
        }

        function createFolder() {
            const name = document.getElementById('folder-name').value.trim();
            if (!name) return alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–∞–ø–∫–∏');

            const folder = {
                id: Date.now(),
                name: name,
                decks: []
            };

            appData.folders.push(folder);
            saveData();
            closeModal('create-folder-modal');
            document.getElementById('folder-name').value = '';
            renderFoldersTree();
            updateStats();
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–ª–æ–¥—ã
        function showCreateDeckModal() {
            const folderSelect = document.getElementById('deck-folder');
            folderSelect.innerHTML = '<option value="">–ë–µ–∑ –ø–∞–ø–∫–∏</option>';
            appData.folders.forEach(folder => {
                folderSelect.innerHTML += `<option value="${folder.id}">${folder.name}</option>`;
            });
            showModal('create-deck-modal');
            setTimeout(() => document.getElementById('deck-name').focus(), 100);
        }

        function createDeck() {
            const name = document.getElementById('deck-name').value.trim();
            const wordsText = document.getElementById('deck-words').value.trim();
            const folderId = document.getElementById('deck-folder').value;

            if (!name) return alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–ª–æ–¥—ã');
            if (!wordsText) return alert('–í–≤–µ–¥–∏—Ç–µ —Å–ª–æ–≤–∞');

            const words = parseWords(wordsText);
            if (words.length === 0) return alert('–ù–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö —Å–ª–æ–≤ –≤ —Ñ–æ—Ä–º–∞—Ç–µ "—Å–ª–æ–≤–æ - –ø–µ—Ä–µ–≤–æ–¥"');

            const deck = {
                id: Date.now(),
                name: name,
                words: words,
                folderId: folderId || null,
                createdAt: new Date().toISOString(),
                iterations: []
            };

            appData.decks.push(deck);
            
            if (folderId) {
                const folder = appData.folders.find(f => f.id == folderId);
                if (folder) {
                    folder.decks.push(deck.id);
                }
            }

            saveData();
            closeModal('create-deck-modal');
            document.getElementById('deck-name').value = '';
            document.getElementById('deck-words').value = '';
            renderFoldersTree();
            renderDecksList();
            updateStats();
            
            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫—É –∫–æ–ª–æ–¥
            document.querySelector('[data-tab="decks"]').click();
        }

        // –ü–∞—Ä—Å–∏–Ω–≥ —Å–ª–æ–≤ –∏–∑ —Ç–µ–∫—Å—Ç–∞
        function parseWords(text) {
            const lines = text.split('\n');
            const words = [];
            let index = 0;

            lines.forEach(line => {
                line = line.trim();
                if (!line) return;

                // –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º —Ä–∞–∑–Ω—ã–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏: -, :, ‚Äî
                const separator = line.includes(' - ') ? ' - ' : 
                                 line.includes(': ') ? ': ' : 
                                 line.includes(' ‚Äî ') ? ' ‚Äî ' : ' ';
                
                const parts = line.split(separator).map(p => p.trim());
                if (parts.length >= 2) {
                    const [eng, ...rusParts] = parts;
                    const rus = rusParts.join(separator);
                    if (eng && rus) {
                        words.push({
                            eng: eng,
                            rus: rus,
                            index: index++
                        });
                    }
                }
            });

            return words;
        }

        // –†–µ–Ω–¥–µ—Ä –¥–µ—Ä–µ–≤–∞ –ø–∞–ø–æ–∫
        function renderFoldersTree() {
            const tree = document.getElementById('folders-tree');
            tree.innerHTML = '';

            // –ö–æ–ª–æ–¥—ã –±–µ–∑ –ø–∞–ø–æ–∫
            const rootDecks = appData.decks.filter(d => !d.folderId);
            if (rootDecks.length > 0) {
                const rootItem = document.createElement('li');
                rootItem.innerHTML = '<strong style="font-size: 0.9rem;">–ö–æ–ª–æ–¥—ã –±–µ–∑ –ø–∞–ø–∫–∏:</strong>';
                tree.appendChild(rootItem);

                const subList = document.createElement('ul');
                rootDecks.forEach(deck => {
                    const deckItem = document.createElement('li');
                    deckItem.className = 'tree-item deck';
                    deckItem.innerHTML = `
                        <span onclick="studyDeck(${deck.id})" style="flex: 1;">${deck.name} (${deck.words.length})</span>
                        <div class="deck-actions">
                            <button onclick="addWordsToDeckModal(${deck.id})" class="action-btn" style="padding: 6px 10px;">+</button>
                            <button onclick="deleteDeck(${deck.id})" class="action-btn btn-danger" style="padding: 6px 10px;">√ó</button>
                        </div>
                    `;
                    subList.appendChild(deckItem);
                });
                tree.appendChild(subList);
            }

            // –ü–∞–ø–∫–∏
            appData.folders.forEach(folder => {
                const folderItem = document.createElement('li');
                folderItem.className = 'tree-item folder';
                folderItem.innerHTML = `
                    <span style="flex: 1;">üìÅ ${folder.name}</span>
                    <button onclick="deleteFolder(${folder.id})" class="btn-danger" style="padding: 6px 10px;">√ó</button>
                `;
                tree.appendChild(folderItem);

                const subList = document.createElement('ul');
                const folderDecks = appData.decks.filter(d => d.folderId == folder.id);
                
                folderDecks.forEach(deck => {
                    const deckItem = document.createElement('li');
                    deckItem.className = 'tree-item deck';
                    deckItem.innerHTML = `
                        <span onclick="studyDeck(${deck.id})" style="flex: 1;">${deck.name} (${deck.words.length})</span>
                        <div class="deck-actions">
                            <button onclick="addWordsToDeckModal(${deck.id})" class="action-btn" style="padding: 6px 10px;">+</button>
                            <button onclick="deleteDeck(${deck.id})" class="action-btn btn-danger" style="padding: 6px 10px;">√ó</button>
                        </div>
                    `;
                    subList.appendChild(deckItem);
                });

                if (folderDecks.length > 0) {
                    tree.appendChild(subList);
                }
            });
        }

        // –†–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞ –∫–æ–ª–æ–¥
        function renderDecksList() {
            const list = document.getElementById('decks-list');
            if (!list) return;
            
            list.innerHTML = '';

            if (appData.decks.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #666; margin-top: 20px;">–ù–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –∫–æ–ª–æ–¥</p>';
                return;
            }

            appData.decks.forEach(deck => {
                const folder = deck.folderId ? appData.folders.find(f => f.id == deck.folderId) : null;
                const iterations = deck.iterations || [];
                const lastIter = iterations.length > 0 ? iterations[iterations.length - 1] : null;
                const knownCount = lastIter ? lastIter.knownWords.length : 0;
                
                const deckEl = document.createElement('div');
                deckEl.className = 'deck-list-item';
                deckEl.innerHTML = `
                    <div style="flex: 1;">
                        <strong style="font-size: 1rem;">${deck.name}</strong>
                        <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">
                            <div>${deck.words.length} —Å–ª–æ–≤</div>
                            <div>${folder ? `–ü–∞–ø–∫–∞: ${folder.name}` : '–ë–µ–∑ –ø–∞–ø–∫–∏'}</div>
                            <div>${iterations.length > 0 ? `–ò–∑—É—á–µ–Ω–æ: ${knownCount}/${deck.words.length}` : '–ï—â–µ –Ω–µ –∏–∑—É—á–∞–ª–∞—Å—å'}</div>
                        </div>
                    </div>
                    <div class="deck-actions" style="margin-top: 10px;">
                        <button onclick="studyDeck(${deck.id})" class="action-btn btn-success" style="flex: 1;">–£—á–∏—Ç—å</button>
                        <button onclick="addWordsToDeckModal(${deck.id})" class="action-btn" style="flex: 1;">+ –°–ª–æ–≤–∞</button>
                        <button onclick="deleteDeck(${deck.id})" class="action-btn btn-danger" style="flex: 1;">√ó</button>
                    </div>
                `;
                list.appendChild(deckEl);
            });
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–ª–æ–≤ –≤ –∫–æ–ª–æ–¥—É
        function addWordsToDeckModal(deckId) {
            appData.currentDeck = appData.decks.find(d => d.id == deckId);
            if (!appData.currentDeck) return;
            
            showModal('add-words-modal');
            setTimeout(() => document.getElementById('new-words').focus(), 100);
        }

        function addWordsToDeck() {
            if (!appData.currentDeck) return;
            
            const text = document.getElementById('new-words').value.trim();
            if (!text) return alert('–í–≤–µ–¥–∏—Ç–µ —Å–ª–æ–≤–∞');

            const newWords = parseWords(text);
            const existingEngWords = new Set(appData.currentDeck.words.map(w => w.eng.toLowerCase()));

            let addedCount = 0;
            newWords.forEach(word => {
                if (!existingEngWords.has(word.eng.toLowerCase())) {
                    word.index = appData.currentDeck.words.length;
                    appData.currentDeck.words.push(word);
                    existingEngWords.add(word.eng.toLowerCase());
                    addedCount++;
                }
            });

            saveData();
            closeModal('add-words-modal');
            document.getElementById('new-words').value = '';
            
            if (addedCount > 0) {
                alert(`–î–æ–±–∞–≤–ª–µ–Ω–æ ${addedCount} –Ω–æ–≤—ã—Ö —Å–ª–æ–≤`);
            } else {
                alert('–í—Å–µ —Å–ª–æ–≤–∞ —É–∂–µ –µ—Å—Ç—å –≤ –∫–æ–ª–æ–¥–µ');
            }
            
            renderFoldersTree();
            renderDecksList();
            updateStats();
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–ª–æ–¥—ã
        function deleteDeck(deckId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –∫–æ–ª–æ–¥—É?')) return;

            appData.decks = appData.decks.filter(d => d.id !== deckId);
            
            appData.folders.forEach(folder => {
                folder.decks = folder.decks.filter(id => id !== deckId);
            });

            saveData();
            renderFoldersTree();
            renderDecksList();
            updateStats();
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –ø–∞–ø–∫–∏
        function deleteFolder(folderId) {
            const folder = appData.folders.find(f => f.id == folderId);
            if (!folder) return;
            
            if (folder.decks.length > 0) {
                if (!confirm('–í –ø–∞–ø–∫–µ –µ—Å—Ç—å –∫–æ–ª–æ–¥—ã. –£–¥–∞–ª–∏—Ç—å –ø–∞–ø–∫—É –∏ –≤—Å–µ –∫–æ–ª–æ–¥—ã –≤–Ω—É—Ç—Ä–∏?')) return;
                
                appData.decks = appData.decks.filter(d => d.folderId !== folderId);
            }
            
            appData.folders = appData.folders.filter(f => f.id !== folderId);
            saveData();
            renderFoldersTree();
            updateStats();
        }

        // –ò–∑—É—á–µ–Ω–∏–µ –∫–æ–ª–æ–¥—ã
        function studyDeck(deckId) {
            appData.currentDeck = appData.decks.find(d => d.id == deckId);
            if (!appData.currentDeck) return;
            
            // –°–æ–∑–¥–∞–µ–º –∫–æ–ø–∏—é —Å–ª–æ–≤ –¥–ª—è —Å–µ—Å—Å–∏–∏
            const sessionWords = [...appData.currentDeck.words];
            
            appData.studySession = {
                deckId: deckId,
                currentIndex: 0,
                knownWords: new Set(),
                unknownWords: new Set(),
                currentIteration: (appData.currentDeck.iterations?.length || 0) + 1,
                isMultiDeck: false,
                sessionWords: sessionWords,
                originalDeckWords: [...appData.currentDeck.words]
            };

            document.getElementById('study-title').textContent = appData.currentDeck.name;
            showModal('study-modal');
            updateStudyUI();
            initSwipe(); // –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–≤–∞–π–ø—ã
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –∏–∑—É—á–µ–Ω–∏—è
        function updateStudyUI() {
            if (!appData.studySession || !appData.studySession.sessionWords) return;

            const session = appData.studySession;
            const words = session.sessionWords;
            
            if (words.length === 0) {
                document.getElementById('card-front').textContent = '–í—Å–µ —Å–ª–æ–≤–∞ –∏–∑—É—á–µ–Ω—ã!';
                document.getElementById('card-back').textContent = 'üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!';
                return;
            }

            // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏–µ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            if (document.getElementById('shuffle-cards').checked && !session.shuffled) {
                shuffleArray(words);
                session.shuffled = true;
            }

            const currentWord = words[session.currentIndex];
            const showReverse = document.getElementById('reverse-cards').checked;

            document.getElementById('card-front').textContent = showReverse ? currentWord.rus : currentWord.eng;
            document.getElementById('card-back').textContent = showReverse ? currentWord.eng : currentWord.rus;
            
            document.getElementById('flashcard').classList.remove('flipped');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
            document.getElementById('current-card').textContent = session.currentIndex + 1;
            document.getElementById('total-cards').textContent = words.length;
            document.getElementById('known-count').textContent = session.knownWords.size;
            document.getElementById('unknown-count').textContent = session.unknownWords.size;
            
            const progress = ((session.currentIndex) / words.length) * 100;
            document.getElementById('progress-fill').style.width = `${progress}%`;
        }

        // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏–µ –º–∞—Å—Å–∏–≤–∞
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // –ü–µ—Ä–µ–≤–æ—Ä–æ—Ç –∫–∞—Ä—Ç–æ—á–∫–∏
        function flipCard() {
            document.getElementById('flashcard').classList.toggle('flipped');
        }

        // –û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –∑–Ω–∞—é
        function markKnown() {
            if (!appData.studySession) return;
            
            const session = appData.studySession;
            const currentWord = session.sessionWords[session.currentIndex];
            
            if (currentWord) {
                session.knownWords.add(currentWord.index);
                session.unknownWords.delete(currentWord.index);
            }
            
            nextCard();
        }

        // –û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –Ω–µ –∑–Ω–∞—é
        function markUnknown() {
            if (!appData.studySession) return;
            
            const session = appData.studySession;
            const currentWord = session.sessionWords[session.currentIndex];
            
            if (currentWord) {
                session.unknownWords.add(currentWord.index);
                session.knownWords.delete(currentWord.index);
            }
            
            nextCard();
        }

        // –°–ª–µ–¥—É—é—â–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞
        function nextCard() {
            if (!appData.studySession) return;
            
            const session = appData.studySession;
            
            session.currentIndex++;
            
            if (session.currentIndex >= session.sessionWords.length) {
                finishStudySession();
            } else {
                updateStudyUI();
            }
        }

        // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏ –∏–∑—É—á–µ–Ω–∏—è
        function finishStudySession() {
            if (!appData.studySession || !appData.currentDeck) return;
            
            const session = appData.studySession;
            const deck = appData.currentDeck;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Ç–µ—Ä–∞—Ü–∏—é
            const iteration = {
                number: session.currentIteration,
                date: new Date().toISOString(),
                totalWords: session.originalDeckWords.length,
                knownWords: Array.from(session.knownWords),
                unknownWords: Array.from(session.unknownWords)
            };
            
            if (!deck.iterations) deck.iterations = [];
            deck.iterations.push(iteration);
            
            saveData();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            const resultMessage = `–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n\n–ó–Ω–∞–µ—Ç–µ: ${session.knownWords.size}\n–ù–µ –∑–Ω–∞–µ—Ç–µ: ${session.unknownWords.size}`;
            
            if (session.isMultiDeck) {
                alert(resultMessage);
                closeModal('study-modal');
            } else {
                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é —Ç–æ–ª—å–∫–æ —Å –Ω–µ–∏–∑—É—á–µ–Ω–Ω—ã–º–∏ —Å–ª–æ–≤–∞–º–∏
                const unknownIndexes = new Set(session.unknownWords);
                const newSessionWords = session.originalDeckWords.filter(word => 
                    unknownIndexes.has(word.index)
                );
                
                if (newSessionWords.length === 0) {
                    alert(resultMessage + '\n\nüéâ –í—Å–µ —Å–ª–æ–≤–∞ –∏–∑—É—á–µ–Ω—ã!');
                    closeModal('study-modal');
                } else {
                    if (confirm(resultMessage + '\n\n–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å –Ω–µ–∏–∑—É—á–µ–Ω–Ω—ã–º–∏ —Å–ª–æ–≤–∞–º–∏?')) {
                        // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å –Ω–µ–∏–∑—É—á–µ–Ω–Ω—ã–º–∏ —Å–ª–æ–≤–∞–º–∏
                        session.sessionWords = newSessionWords;
                        session.currentIndex = 0;
                        session.knownWords.clear();
                        session.unknownWords.clear();
                        session.shuffled = false;
                        updateStudyUI();
                    } else {
                        closeModal('study-modal');
                    }
                }
            }
            
            updateStats();
        }

        // –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ
        function restartDeck() {
            if (!appData.studySession || !appData.currentDeck) return;
            
            appData.studySession.currentIndex = 0;
            appData.studySession.knownWords.clear();
            appData.studySession.unknownWords.clear();
            appData.studySession.shuffled = false;
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ —Å–ª–æ–≤
            appData.studySession.sessionWords = [...appData.studySession.originalDeckWords];
            
            updateStudyUI();
        }

        // –ú—É–ª—å—Ç–∏–∫–æ–ª–æ–¥–∞
        function renderMultiDeckSelect() {
            const container = document.getElementById('multi-decks-select');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (appData.decks.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center;">–ù–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –∫–æ–ª–æ–¥</p>';
                return;
            }
            
            appData.decks.forEach(deck => {
                const lastIter = deck.iterations && deck.iterations.length > 0 
                    ? deck.iterations[deck.iterations.length - 1]
                    : null;
                const knownCount = lastIter ? lastIter.knownWords.length : 0;
                
                const div = document.createElement('div');
                div.style.cssText = 'margin-bottom: 10px; padding: 10px; background: #f8fafc; border-radius: 8px;';
                div.innerHTML = `
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" value="${deck.id}" data-deck="${deck.id}" style="width: 20px; height: 20px;">
                        <div>
                            <div style="font-weight: 500;">${deck.name}</div>
                            <div style="font-size: 0.8rem; color: #666;">
                                ${deck.words.length} —Å–ª–æ–≤, –∏–∑—É—á–µ–Ω–æ: ${knownCount}/${deck.words.length}
                            </div>
                        </div>
                    </label>
                `;
                container.appendChild(div);
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞
            const modeSelect = document.getElementById('multi-mode');
            if (modeSelect) {
                modeSelect.addEventListener('change', (e) => {
                    const iterationSelectors = document.getElementById('iteration-selectors');
                    iterationSelectors.style.display = e.target.value === 'iteration' ? 'block' : 'none';
                    if (e.target.value === 'iteration') {
                        renderIterationSelectors();
                    }
                });
            }
        }

        function renderIterationSelectors() {
            const container = document.getElementById('iteration-selectors');
            if (!container) return;
            
            container.innerHTML = '<h4 style="font-size: 1rem; margin-bottom: 10px;">–í—ã–±–µ—Ä–∏—Ç–µ –∏—Ç–µ—Ä–∞—Ü–∏–∏:</h4>';
            
            let hasIterations = false;
            
            appData.decks.forEach(deck => {
                if (deck.iterations && deck.iterations.length > 0) {
                    hasIterations = true;
                    const div = document.createElement('div');
                    div.style.cssText = 'margin-bottom: 15px;';
                    div.innerHTML = `
                        <div style="font-weight: 500; margin-bottom: 5px;">${deck.name}:</div>
                        <div class="iteration-selector" id="iterations-${deck.id}" style="display: flex; gap: 5px; flex-wrap: wrap;"></div>
                    `;
                    container.appendChild(div);
                    
                    const selector = document.getElementById(`iterations-${deck.id}`);
                    deck.iterations.forEach(iter => {
                        const btn = document.createElement('button');
                        btn.className = 'iteration-btn';
                        btn.textContent = `#${iter.number}`;
                        btn.dataset.deckId = deck.id;
                        btn.dataset.iterNum = iter.number;
                        btn.style.cssText = 'padding: 6px 12px; font-size: 14px; background: #f1f5f9; border: none; border-radius: 6px; cursor: pointer;';
                        btn.onclick = function(e) {
                            e.preventDefault();
                            document.querySelectorAll(`#iterations-${deck.id} .iteration-btn`).forEach(b => 
                                b.style.background = '#f1f5f9'
                            );
                            this.style.background = '#4f46e5';
                            this.style.color = 'white';
                        };
                        selector.appendChild(btn);
                    });
                }
            });
            
            if (!hasIterations) {
                container.innerHTML += '<p style="color: #666; text-align: center;">–ù–µ—Ç –∫–æ–ª–æ–¥ —Å –∏—Ç–µ—Ä–∞—Ü–∏—è–º–∏</p>';
            }
        }

        function startMultiDeck() {
            const selectedDeckIds = Array.from(
                document.querySelectorAll('#multi-decks-select input:checked')
            ).map(input => parseInt(input.value));
            
            if (selectedDeckIds.length === 0) {
                return alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –∫–æ–ª–æ–¥—É');
            }
            
            const mode = document.getElementById('multi-mode').value;
            let allWords = [];
            
            selectedDeckIds.forEach(deckId => {
                const deck = appData.decks.find(d => d.id == deckId);
                if (!deck) return;
                
                let wordsToAdd = [];
                
                if (mode === 'all') {
                    wordsToAdd = deck.words.map(w => ({...w, deckId: deck.id}));
                } else if (mode === 'unknown') {
                    // –ë–µ—Ä–µ–º —Å–ª–æ–≤–∞ –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏ –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –∑–Ω–∞–ª
                    if (deck.iterations && deck.iterations.length > 0) {
                        const lastIter = deck.iterations[deck.iterations.length - 1];
                        wordsToAdd = deck.words
                            .filter((_, idx) => lastIter.unknownWords.includes(idx))
                            .map(w => ({...w, deckId: deck.id}));
                    } else {
                        wordsToAdd = deck.words.map(w => ({...w, deckId: deck.id}));
                    }
                } else if (mode === 'iteration') {
                    // –ë–µ—Ä–µ–º —Å–ª–æ–≤–∞ –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏
                    const iterBtn = document.querySelector(`#iterations-${deckId} .iteration-btn[style*="background: #4f46e5"]`);
                    if (iterBtn) {
                        const iterNum = parseInt(iterBtn.dataset.iterNum);
                        const iteration = deck.iterations.find(iter => iter.number === iterNum);
                        if (iteration) {
                            wordsToAdd = deck.words
                                .filter((_, idx) => iteration.unknownWords.includes(idx))
                                .map(w => ({...w, deckId: deck.id}));
                        }
                    } else {
                        alert(`–î–ª—è –∫–æ–ª–æ–¥—ã "${deck.name}" –Ω–µ –≤—ã–±—Ä–∞–Ω–∞ –∏—Ç–µ—Ä–∞—Ü–∏—è`);
                        return;
                    }
                }
                
                allWords = [...allWords, ...wordsToAdd];
            });
            
            if (allWords.length === 0) {
                return alert('–ù–µ—Ç —Å–ª–æ–≤ –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è');
            }
            
            // –°–æ–∑–¥–∞–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é –∫–æ–ª–æ–¥—É –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è
            const multiDeck = {
                id: 'multi-' + Date.now(),
                name: '–ú—É–ª—å—Ç–∏–∫–æ–ª–æ–¥–∞',
                words: allWords
            };
            
            appData.currentDeck = multiDeck;
            
            appData.studySession = {
                deckId: 'multi',
                currentIndex: 0,
                knownWords: new Set(),
                unknownWords: new Set(),
                currentIteration: 1,
                isMultiDeck: true,
                sessionWords: [...allWords],
                originalDeckWords: [...allWords]
            };
            
            document.getElementById('study-title').textContent = '–ú—É–ª—å—Ç–∏–∫–æ–ª–æ–¥–∞';
            showModal('study-modal');
            updateStudyUI();
            initSwipe();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function updateStats() {
            let totalWords = 0;
            let learnedWords = 0;
            let totalKnown = 0;
            let totalUnknown = 0;
            
            appData.decks.forEach(deck => {
                totalWords += deck.words.length;
                
                if (deck.iterations && deck.iterations.length > 0) {
                    const lastIter = deck.iterations[deck.iterations.length - 1];
                    totalKnown += lastIter.knownWords.length;
                    totalUnknown += lastIter.unknownWords.length;
                }
            });
            
            learnedWords = totalKnown;
            
            const totalWordsEl = document.getElementById('total-words');
            const learnedWordsEl = document.getElementById('learned-words');
            const totalDecksEl = document.getElementById('total-decks');
            const totalFoldersEl = document.getElementById('total-folders');
            
            if (totalWordsEl) totalWordsEl.textContent = totalWords;
            if (learnedWordsEl) learnedWordsEl.textContent = learnedWords;
            if (totalDecksEl) totalDecksEl.textContent = appData.decks.length;
            if (totalFoldersEl) totalFoldersEl.textContent = appData.folders.length;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –∫–æ–ª–æ–¥–∞–º
            const deckStats = document.getElementById('deck-stats');
            if (deckStats) {
                if (appData.decks.length === 0) {
                    deckStats.innerHTML = '<p style="text-align: center; color: #666;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';
                    return;
                }
                
                deckStats.innerHTML = '<h4 style="font-size: 1rem; margin-bottom: 15px;">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–æ–ª–æ–¥–∞–º:</h4>';
                
                appData.decks.forEach(deck => {
                    const lastIter = deck.iterations && deck.iterations.length > 0 
                        ? deck.iterations[deck.iterations.length - 1]
                        : null;
                    const knownCount = lastIter ? lastIter.knownWords.length : 0;
                    const progress = deck.words.length > 0 ? Math.round((knownCount / deck.words.length) * 100) : 0;
                    
                    const statEl = document.createElement('div');
                    statEl.className = 'deck-list-item';
                    statEl.innerHTML = `
                        <div style="flex: 1;">
                            <strong style="font-size: 1rem;">${deck.name}</strong>
                            <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">
                                <div>–°–ª–æ–≤: ${deck.words.length}</div>
                                <div>–ò–∑—É—á–µ–Ω–æ: ${knownCount} (${progress}%)</div>
                                <div>–ò—Ç–µ—Ä–∞—Ü–∏–π: ${deck.iterations?.length || 0}</div>
                            </div>
                        </div>
                        <button onclick="studyDeck(${deck.id})" class="action-btn" style="margin-top: 10px;">–£—á–∏—Ç—å</button>
                    `;
                    deckStats.appendChild(statEl);
                });
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–±–æ—Ä –¥–ª—è –º—É–ª—å—Ç–∏–∫–æ–ª–æ–¥—ã
            if (document.getElementById('multi-decks-select')) {
                renderMultiDeckSelect();
            }
        }

        // –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
        function exportData() {
            try {
                const dataStr = JSON.stringify(appData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                const exportFileDefaultName = 'flashcards-backup-' + new Date().toISOString().split('T')[0] + '.json';
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
            } catch (e) {
                alert('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö');
            }
        }

        // –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = e => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                
                reader.onload = event => {
                    try {
                        if (!confirm('–ó–∞–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ? –í—Å–µ –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã.')) return;
                        
                        const importedData = JSON.parse(event.target.result);
                        appData = importedData;
                        saveData();
                        
                        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º UI
                        renderFoldersTree();
                        renderDecksList();
                        updateStats();
                        alert('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!');
                    } catch (err) {
                        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –¥–∞–Ω–Ω—ã—Ö. –§–∞–π–ª –ø–æ–≤—Ä–µ–∂–¥–µ–Ω –∏–ª–∏ –∏–º–µ–µ—Ç –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç.');
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }
    </script>
</body>
</html>
